name: Build and Deploy ERP API

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Install DevOps Tools
      uses: Bengo-Hub/devops-k8s/.github/actions/install-devops-tools@main

    - name: Debug available secrets
      run: |
        echo "Checking which tokens are available..."
        [[ -n "${{ secrets.GH_PAT }}" ]] && echo "✅ GH_PAT is set" || echo "❌ GH_PAT not found"
        [[ -n "${{ secrets.GIT_SECRET }}" ]] && echo "✅ GITHUB_SECRET is set" || echo "❌ GITHUB_SECRET not found"
        [[ -n "${{ secrets.GITHUB_TOKEN }}" ]] && echo "✅ GITHUB_TOKEN is set (default, may lack cross-repo write)" || echo "❌ GITHUB_TOKEN not found"
        echo "Note: At least GH_PAT or GITHUB_SECRET must be set for cross-repo push to devops-k8s"

    - name: Set deployment variables
      run: |
        echo "DEPLOY=true" >> $GITHUB_ENV
        echo "SETUP_DATABASES=true" >> $GITHUB_ENV
        echo "DB_TYPES=postgres,redis" >> $GITHUB_ENV
        echo "NAMESPACE=erp" >> $GITHUB_ENV
        echo "ENV_SECRET_NAME=erp-api-env" >> $GITHUB_ENV
        echo "REGISTRY_SERVER=docker.io" >> $GITHUB_ENV
        echo "REGISTRY_NAMESPACE=codevertex" >> $GITHUB_ENV
        echo "VALUES_FILE_PATH=apps/erp-api/values.yaml" >> $GITHUB_ENV
        echo "DEPLOYMENT_SUMMARY_TITLE=BengoERP API Deployment Summary" >> $GITHUB_ENV
        echo "DEPLOYMENT_SUCCESS_MESSAGE=BengoERP API deployment completed! The API should be accessible via the URLs above." >> $GITHUB_ENV
        echo "APPLICATION_DISPLAY_NAME=BengoERP API" >> $GITHUB_ENV

    - name: Run production deployment
      env:
        DOCKER_SSH_KEY: ${{ secrets.DOCKER_SSH_KEY }}
        KUBE_CONFIG: ${{ secrets.KUBE_CONFIG }}
        # Use GH token for HTTPS auth fallback in build.sh
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        GH_PAT: ${{ secrets.GH_PAT }}
        GITHUB_SECRET: ${{ secrets.GIT_SECRET }}
        REGISTRY_USERNAME: ${{ secrets.REGISTRY_USERNAME }}
        REGISTRY_PASSWORD: ${{ secrets.REGISTRY_PASSWORD }}
        GITHUB_SHA: ${{ github.sha }}
        DEPLOY: true
        SETUP_DATABASES: true
        DB_TYPES: postgres,redis
        NAMESPACE: erp
        ENV_SECRET_NAME: erp-api-env
        # Prefer dedicated app DB user if provided; fallback handled in build.sh
        APP_DB_USER: ${{ secrets.APP_DB_USER }}
        REGISTRY_SERVER: docker.io
        REGISTRY_NAMESPACE: codevertex
        VALUES_FILE_PATH: apps/erp-api/values.yaml
        GIT_USER: ${{ secrets.GIT_USER }}
        GIT_EMAIL: ${{ secrets.GIT_EMAIL }}
        # SSH deployment variables
        SSH_HOST: ${{ secrets.SSH_HOST }}
        SSH_USER: ${{ secrets.SSH_USER }}
        SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
        PROVIDER: contabo
        CONTABO_API: true
        # Database secrets and configuration
        POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
        REDIS_PASSWORD: ${{ secrets.REDIS_PASSWORD }}
        PG_DATABASE: bengo_erp
        # Optional: enable DB validation debug
        DEBUG_DB_VALIDATION: ${{ secrets.DEBUG_DB_VALIDATION || 'false' }}
        # Django application secrets
        DJANGO_SECRET_KEY: ${{ secrets.DJANGO_SECRET_KEY || 'change-me-strong' }}
        # Email configuration (optional)
        EMAIL_HOST_USER: ${{ secrets.EMAIL_HOST_USER || 'info@codevertexitsolutions.com' }}
        EMAIL_HOST_PASSWORD: ${{ secrets.EMAIL_HOST_PASSWORD || 'CodeVertex@2025' }}
        EMAIL_HOST: ${{ secrets.EMAIL_HOST || 'smtp.gmail.com' }}
        EMAIL_PORT: ${{ secrets.EMAIL_PORT || '587' }}
        # Contabo secrets
        CONTABO_CLIENT_ID: ${{ secrets.CONTABO_CLIENT_ID }}
        CONTABO_CLIENT_SECRET: ${{ secrets.CONTABO_CLIENT_SECRET }}
        CONTABO_API_USERNAME: ${{ secrets.CONTABO_API_USERNAME }}
        CONTABO_API_PASSWORD: ${{ secrets.CONTABO_API_PASSWORD }}
        # Deployment variables
        DEPLOYMENT_SUMMARY_TITLE: BengoERP API Deployment Summary
        DEPLOYMENT_SUCCESS_MESSAGE: BengoERP API deployment completed! The API should be accessible via the URLs above.
        APPLICATION_DISPLAY_NAME: BengoERP API
      run: |
        chmod +x build.sh
        # Make sure DB vars are exported in shell (avoid masking by YAML env scoping)
        export POSTGRES_PASSWORD="${POSTGRES_PASSWORD}"
        export APP_DB_USER="${APP_DB_USER:-erp_user}"
        export PG_DATABASE="${PG_DATABASE:-bengo_erp}"
        ./build.sh

    - name: Tag and push :latest
      if: success()
      env:
        REGISTRY_USERNAME: ${{ secrets.REGISTRY_USERNAME }}
        REGISTRY_PASSWORD: ${{ secrets.REGISTRY_PASSWORD }}
      run: |
        set -e
        : "${REGISTRY_SERVER:=docker.io}"
        : "${REGISTRY_NAMESPACE:=codevertex}"
        IMAGE_REPO="${REGISTRY_SERVER}/${REGISTRY_NAMESPACE}/erp-api"
        SHORT_SHA=${GITHUB_SHA::8}
        echo "Tagging ${IMAGE_REPO}:${SHORT_SHA} as :latest and pushing"
        echo "$REGISTRY_PASSWORD" | docker login "$REGISTRY_SERVER" -u "$REGISTRY_USERNAME" --password-stdin
        # Ensure the commit-tagged image is available locally
        docker pull "${IMAGE_REPO}:${SHORT_SHA}" || true
        docker tag "${IMAGE_REPO}:${SHORT_SHA}" "${IMAGE_REPO}:latest"
        docker push "${IMAGE_REPO}:latest"

    - name: Verify API health
      if: success()
      env:
        KUBE_CONFIG_B64: ${{ secrets.KUBE_CONFIG }}
        NS: erp
      run: |
        if [ -z "${KUBE_CONFIG_B64}" ]; then
          echo "⏭️ Skipping health check - no KUBE_CONFIG available"
          exit 0
        fi

        echo "::group::Health check"
        mkdir -p ~/.kube
        echo "$KUBE_CONFIG_B64" | base64 -d > ~/.kube/config

        # Ensure deployment is rolled out (deployment name is erp-api-app from Helm chart)
        # Increased timeout to 20 minutes (1200s) as requested for heavy migrations
        kubectl rollout status deployment/erp-api-app -n ${NS} --timeout=1200s

        # Try ingress health endpoint(s)
        HOSTS=$(kubectl get ingress -n ${NS} -o jsonpath='{.items[*].spec.rules[*].host}' | tr ' ' '\n' | grep -E '^erpapi(\.|$)' || true)
        if [ -n "$HOSTS" ]; then
          STATUS=1
          for H in $HOSTS; do
            echo "Checking https://$H/api/v1/core/health/ ..."
            if curl -sk --max-time 10 "https://$H/api/v1/core/health/" | grep -Ei "ok|healthy" >/dev/null; then
              echo "✅ Health OK for $H"
              STATUS=0
              break
            fi
          done
          if [ $STATUS -ne 0 ]; then
            echo "⚠️ Health endpoint did not return OK; rollout completed but endpoint may still be initializing"
          fi
        else
          echo "No ingress host found; skipping external health probe"
        fi
        echo "::endgroup::"
